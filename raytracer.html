<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chai/4.3.4/chai.min.js"
        integrity="sha512-gkZWobgJrQevN2HMEeTnSlxWPJ3HS0JJ3nXcgI6XLK/NI0z59jbztRZqbTlIzfl21vIGahQaeW0knwH1az/tbg=="
        crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <title>Raytracer</title>
</head>

<body>
    <canvas id="canvas"></canvas>

    <script>
        // ************************ TUPLE ***********************************************************
        const EPSILON = 0.00001;

        function equal(a, b) {
            return Math.abs(a - b) < EPSILON;
        }

        function tuple(x, y, z, w) {
            return { x, y, z, w };
        }

        function point(x, y, z) {
            return { x, y, z, w: 1 };
        }

        function vector(x, y, z) {
            return { x, y, z, w: 0 }
        }

        function add_tuple(a, b) {
            return { x: a.x + b.x, y: a.y + b.y, z: a.z + b.z, w: a.w + b.w };
        }

        function sub_tuple(a, b) {
            return { x: a.x - b.x, y: a.y - b.y, z: a.z - b.z, w: a.w - b.w };
        }
        function negate(t) {
            return { x: -t.x, y: -t.y, z: -t.z, w: -t.w };
        }
        function multiply_tuple(t, s) {
            return { x: t.x * s, y: t.y * s, z: t.z * s, w: t.w * s };
        }
        function divide_tuple(t, s) {
            return { x: t.x / s, y: t.y / s, z: t.z / s, w: t.w / s };
        }
        function magnitude(t) {
            return Math.sqrt(t.x * t.x + t.y * t.y + t.z * t.z + t.w * t.w);
        }
        function normalize(t) {
            const m = magnitude(t);
            return divide_tuple(t, m);
        }
        function dot(t, a) {
            return a.x * t.x + a.y * t.y + a.z * t.z + a.w * t.w;
        }
        function cross(t, b) {
            return vector(t.y * b.z - t.z * b.y,
                t.z * b.x - t.x * b.z,
                t.x * b.y - t.y * b.x);

        }
        function reflect(t, normal) {
            return sub_tuple(t, multiply_tuple(normal, 2 * dot(t, normal)));

        }
        function equal_tuple(a, b) {
            return equal(a.x, b.x) && equal(a.y, b.y) && equal(a.z, b.z) && equal(a.w, b.w);
        }

        /*************** COLOR ************************************************************/

        function color(r, g, b) {
            return { red: r, green: g, blue: b };
        }

        function add_color(a, b) {
            return { red: a.red + b.red, green: a.green + b.green, blue: a.blue + b.blue };
        }
        function sub_color(a, b) {
            return { red: a.red - b.red, green: a.green - b.green, blue: a.blue - b.blue };
        }
        function multiply_color(a, k) {
            return { red: a.red * k, green: a.green * k, blue: a.blue * k };
        }
        function hadamard_color(a, b) {
            return { red: a.red * b.red, green: a.green * b.green, blue: a.blue * b.blue };

        }

        /************* CANVAS ***********************************************************/

        function canvas(width, height) {


            return { width: width, height: height, pixels: new Array(width * height).fill(color(0, 0, 0)) };
        }

        function init_canvas(sel, width, height) {
            const c = document.querySelector(sel);
            c.width = width;
            c.height = height;
            const ctx = c.getContext('2d');
            const data = ctx.getImageData(0, 0, width, height);
            for (let i=0;i<width*height;i++){
               data.data[i*4+3]=255;
            }
            return { canvas: c, ctx: ctx, data: data };

        }

        function write_pixel(canvas, x, y, color) {
            canvas.pixels[canvas.width * y + x] = color;
        }
        function pixel_at(canvas, x, y) {
            return canvas.pixels[canvas.width * y + x];
        }

        function draw_pixel(canvas, x, y, color, update = false) {
            const r = Math.floor(color.red * 255.999);
            const g = Math.floor(color.green * 255.999);
            const b = Math.floor(color.blue * 255.999);
            const off = (x + y * canvas.data.width) * 4;
            canvas.data.data[off] = r;
            canvas.data.data[off + 1] = g;
            canvas.data.data[off + 2] = b;
            canvas.data.data[off + 3] = 255;
           // console.log(color);
            if (update) {
                canvas.ctx.putImageData(0, 0, canvas.data);
            }

        }
        function update_canvas(canvas) {
            canvas.ctx.putImageData(canvas.data, 0, 0);
        }
        function read_pixel(canvas, x, y) {
            return { red: 0, green: 0, blue: 0 };
        }


        const c = init_canvas("#canvas", 360, 240);
        console.log(c);
        for (let i = 0; i < 100; i++) {
            draw_pixel(c, i, i, color(0.5, 0.5, 0));
        }
        update_canvas(c);

        /**********************************************************************************/
        /*                                     TEST                                       */
        /**********************************************************************************/
        {
            let a = tuple(4.3, -4.2, 3.1, 1.0);
            chai.assert.equal(a.x, 4.3);
            chai.assert.equal(a.y, -4.2);
            chai.assert.equal(a.z, 3.1);
            chai.assert.equal(a.w, 1.0);
            let p = point(4, -4, 3);
            chai.assert.deepEqual(p, tuple(4, -4, 3, 1));
            let v = vector(4, -4, 3);
            chai.assert.deepEqual(v, tuple(4, -4, 3, 0));
            v = vector(-1, -2, -3);
            chai.assert.equal(magnitude(v), Math.sqrt(14));
            let n = normalize(v);
            chai.assert.equal(n.x, -1 / Math.sqrt(14));
            chai.assert.equal(n.y, -2 / Math.sqrt(14));
            chai.assert.equal(n.z, -3 / Math.sqrt(14));
            a = vector(1, 2, 3)
            let b = vector(2, 3, 4)
            chai.assert.equal(dot(a, b), 20);
            chai.assert.deepEqual(cross(a, b), vector(-1, 2, -1));
            chai.assert.deepEqual(cross(b, a), vector(1, -2, 1));
        }



    </script>

</body>

</html>
